<html>
<div id="output" style="max-width:600px;">loading</div>

<style>
  a {text-decoration: none;}
</style>

<script>

  let site = 'https://thompson.wiki.innovateoregon.org'
  let chapters = ["The Dayton Experiment: Index"]
  let appendix = []
  let pageinfo = {}

  function merge (array, element) {
    if (!array.includes(element)) {
      array.push(element)
    }
  }

  function slug (title) {
    return title
      .replace(/\s/g, '-')
      .replace(/[^A-Za-z0-9-]/g, '')
      .toLowerCase()
  }

  function json (url) {
    return fetch(url)
      .then(res => res.json())
  }

  function link (title) {
    let info = pageinfo[slug(title)]||({synopsis:'We could not find this page'})
    let hover = info.synopsis.replace(/"/g,"'").replace(/<.*?>/g,'')
    return `<a href="#${slug(title)}" title="${hover}">${title}</a>`
  }

  function item (type, text) {
    const href = (m) => {
      var title = m.slice(2,-2)
      merge(appendix, title)
      return link(title)
    }
    switch(type) {
      case 'html':
        text = text.replace(/<.*?>/,'')
        break
      case 'markdown':
        text = text.replace(/_(.+)_/g,"<i>$1</i>")
        break
    }
    if (m = /^\[\[(.*?)\]\]$/.exec(text)) {
      if (!chapters.includes(m[1])) chapters.push(m[1])
    }
    return `<p>${text.replace(/\[\[(.+?)\]\]/g,href)}</p>`
  }

  function title (page) {
    let s = slug(page.title)
    return `<h3><a name=${s}>${page.title}</a><a href="${site}/${s}.html" target=_blank> â¬€ </a></h3>`
  }

  function story (page) {
    return page.story.map(each => item(each.type, each.text)).join("\n")
  }

  function draft (pages) {
    output.innerHTML = 'formatting'
    const trouble = (title) => ({title, story:[{text:'We could not find this page'}]})
    let body = []
    for (var each of chapters) {
      let chapter = pages[slug(each)]||trouble(each)
      body.push(title(chapter) + story(chapter))
      if (each == chapters[0]) {
        body.push('<p><a href="#appendix">Appendix</a></p>')
        body.push('<p><a href="#index">Index</a></p>')
      }
    }
    body.push('<a name=appendix><h2>Appendix</h2></a>')
    for (var each of appendix) {
      if (!chapters.includes(each)) {
        let chapter = pages[slug(each)]||trouble(each)
        body.push(title(chapter) + story(chapter))
      }
    }
    body.push('<a name=index><h2>Index</h2></a>')
    appendix.sort()
    body.push(appendix.map(link).join("<br>\n"))
    output.innerHTML = body.join("\n")
  }

  function asmap (array) {
    const bemap = (map, each) => {map[slug(each.title)] = each; return map}
    return array.reduce(bemap, {})
  }

  async function load () {
    let sitemap = await json(`${site}/system/sitemap.json`)
    pageinfo = asmap(sitemap)
    output.innerHTML = `loading ${sitemap.length} pages`
    Promise.all(sitemap.map(each => json(`${site}/${each.slug}.json`)))
      .then(all => draft(asmap(all)))
  }

  load()

</script>
<html>
